<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SC090JXSHE"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SC090JXSHE');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Plana - Food in New York City</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mystyles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" href="favicon.png" type="image/x-icon">
</head>
<body>
    <div class="site-header">
        <div class="site-header-content">
            <div class="header-top">
                <div class="banner">
                    <a href="https://makeplana.com">Plana</a>
                </div>
                <a href="https://makeplana.com/account" class="account-section"><span>ðŸ‘¤</span>Account</a>
            </div>
            <div class="filters-container">
                <div class="filter-group">
                    <button class="filter-button" data-filter="meal">Meal</button>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="meal" value="lunch"> Lunch
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="meal" value="brunch"> Brunch
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="meal" value="dinner"> Dinner
                        </label>
                    </div>
                </div>
                <div class="filter-group">
                    <button class="filter-button" data-filter="price">Price Range</button>
                    <div class="filter-options">
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="$"> $
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="$$"> $$
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="$$$"> $$$
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" name="price" value="$$$$"> $$$$
                        </label>
                    </div>
                </div>
                <div class="filter-group" data-filter="cuisine">
                    <button class="filter-button" data-filter="cuisine">Cuisine</button>
                    <div class="filter-options">
                        <!-- dynamically generated cuisine options will go here -->
                    </div>
                </div>
            </div>
        </div>
        <div class="header-bottom-line"></div>
    </div>

    <div class="results-container">
        <div id="map-view"></div>
        <div class="resize-handle"></div>
        <div id="restaurant-list"></div>
    </div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
class RestaurantDisplay {
    constructor() {
        this.restaurants = [];
        this.selectedPrices = new Set();
        this.selectedMeals = new Set();
        this.selectedCuisines = new Set();
        this.map = null;
        this.initializeMap();
        this.initializeResizeHandle();
    }

    initializeResizeHandle() {
    const handle = document.querySelector('.resize-handle');
    const container = document.querySelector('.results-container');
    const mapView = document.getElementById('map-view');
    const listView = document.getElementById('restaurant-list');
    let isResizing = false;
    let startY;
    let lastY;

    const SNAP_THRESHOLD = 30; // Pixels for snapping

    const startResize = (clientY) => {
        isResizing = true;
        startY = clientY;
        lastY = clientY;
        document.body.classList.add('resizing');
    };

    const performResize = (clientY) => {
        if (!isResizing) return;

        lastY = clientY;
        const containerRect = container.getBoundingClientRect();
        const containerHeight = containerRect.height;
        const y = clientY - containerRect.top;

        const mapPercent = (y / containerHeight) * 100;
        const listPercent = 100 - mapPercent;

        if (mapPercent >= 20 && listPercent >= 20) {
            mapView.style.height = `${mapPercent}%`;
            listView.style.height = `${listPercent}%`;
            if (this.map) {
                this.map.invalidateSize();
            }
        }
    };

    const stopResize = () => {
    if (!isResizing) return;
    isResizing = false;
    document.body.classList.remove('resizing');

    // Detect if we are on mobile
    const isMobile = window.innerWidth <= 768; // Mobile view breakpoint

    // Get the current height percentages
    const mapPercent = parseFloat(mapView.style.height); // Current map height in %
    const listPercent = 100 - mapPercent;

    // Snapping logic
    if (isMobile) {
        // Mobile: Only snap to dominant positions
        if (mapPercent > 50) {
            // Snap to mapView dominant
            mapView.style.height = '80%';
            listView.style.height = '20%';
        } else {
            // Snap to listView dominant
            mapView.style.height = '20%';
            listView.style.height = '80%';
        }
    } else {
        // Desktop: Keep the middle snap logic if needed in future
        if (mapPercent > 70) {
            // Snap to mapView dominant
            mapView.style.height = '80%';
            listView.style.height = '20%';
        } else if (listPercent > 70) {
            // Snap to listView dominant
            mapView.style.height = '20%';
            listView.style.height = '80%';
        } else {
            // Snap to middle
            mapView.style.height = '50%';
            listView.style.height = '50%';
        }
    }

    // Adjust map size if present
    if (this.map) {
        this.map.invalidateSize();
    }
};

    // Mouse events
    handle.addEventListener('mousedown', (e) => startResize(e.clientY));
    document.addEventListener('mousemove', (e) => performResize(e.clientY));
    document.addEventListener('mouseup', stopResize);

    // Touch events
    handle.addEventListener('touchstart', (e) => startResize(e.touches[0].clientY), { passive: false });
    document.addEventListener('touchmove', (e) => performResize(e.touches[0].clientY), { passive: false });
    document.addEventListener('touchend', stopResize);

    // Double click to reset
    handle.addEventListener('dblclick', () => {
        mapView.style.height = '50%';
        listView.style.height = '50%';
        if (this.map) {
            this.map.invalidateSize();
        }
    });
}


    initializeMap() {
        this.map = L.map('map-view').setView([40.7128, -74.0060], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19,
            className: 'leaflet-dark'
        }).addTo(this.map);
    }

    async updateDisplay() {
        const container = document.getElementById('restaurant-list');
        container.innerHTML = '<p>Loading...</p>';

        const fetchDataPromise = (async () => this.filterRestaurants())();
        const minimumWaitPromise = new Promise(resolve => setTimeout(resolve, 1000));

        const filteredRestaurants = await Promise.all([fetchDataPromise, minimumWaitPromise]).then(results => results[0]);

        container.innerHTML = '';

        if (filteredRestaurants.length === 0) {
            const noResultsMessage = document.createElement('p');
            noResultsMessage.textContent = 'No restaurants found. Please broaden your search settings.';
            container.appendChild(noResultsMessage);
        } else {
            filteredRestaurants.forEach(restaurant => {
                container.appendChild(this.createRestaurantBox(restaurant));
            });
        }

        this.updateMap(filteredRestaurants);
    }

    async fetchRestaurants() {
        try {
            const isProd = window.location.hostname === 'makeplana.com';
            const API_BASE_URL = isProd 
                ? 'https://jasonlpapadopoulos-github-io.onrender.com' 
                : 'http://localhost:3000';

            const apiUrl = `${API_BASE_URL}/api/food`;

            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            this.restaurants = data;
            this.createCuisineFilterOptions();
            return this.restaurants;
        } catch (error) {
            console.error('Error fetching restaurant data:', error);
            return [];
        }
    }
    
    getSelectedNeighborhoods() {
        const selectedNeighborhoods = localStorage.getItem('selectedNeighborhoods');
        return selectedNeighborhoods ? JSON.parse(selectedNeighborhoods) : [];
    }

    filterRestaurants() {
        const selectedNeighborhoods = this.getSelectedNeighborhoods();
        if (selectedNeighborhoods.length === 0) return [];
        
        return this.restaurants.filter(restaurant => {
            const neighborhoodMatch = selectedNeighborhoods.includes(restaurant.neighborhood_clean);
            const priceMatch = this.selectedPrices.size === 0 || this.selectedPrices.has(restaurant.budget);
            const mealMatch = this.selectedMeals.size === 0 || [...this.selectedMeals].some(meal => 
                restaurant[meal.toLowerCase()] === 1
            );
            const cuisineMatch = this.selectedCuisines.size === 0 || 
                               this.selectedCuisines.has(restaurant.cuisine_clean);

            return neighborhoodMatch && priceMatch && mealMatch && cuisineMatch;
        });
    }

    createRestaurantBox(restaurant) {
        const box = document.createElement('div');
        box.className = 'place-box';

        const restaurantPageUrl = `restaurants/${restaurant.place_name_clean}-${restaurant.neighborhood_clean}`;

        box.innerHTML = `
            <a href="${restaurantPageUrl}" class="restaurant-link">
                <div class="restaurant-content">
                    <strong>${restaurant.place_name}</strong><br>
                    <i>${restaurant.cuisine}, ${restaurant.budget}</i><br><br>
                    
                    <img src="${restaurant.image_url}" alt="${restaurant.place_name}" 
                        onerror="this.src='https://via.placeholder.com/300x200.png?text=No+Image'"
                        style="max-width: 100%; height: auto;">
                    <br><br>
                    
                    ${restaurant.description || ''}<br><br>
                </div>
            </a>
        `;

        // Add hover effect to highlight marker on map
        box.addEventListener('mouseenter', () => {
            if (restaurant.lat && restaurant.lon) {
                const marker = this.findMarker(restaurant);
                if (marker) {
                    marker.openPopup();
                }
            }
        });

        box.addEventListener('mouseleave', () => {
            if (restaurant.lat && restaurant.lon) {
                const marker = this.findMarker(restaurant);
                if (marker) {
                    marker.closePopup();
                }
            }
        });
        
        return box;
    }

    findMarker(restaurant) {
        let foundMarker = null;
        this.map.eachLayer((layer) => {
            if (layer instanceof L.Marker) {
                const markerLatLng = layer.getLatLng();
                if (markerLatLng.lat === parseFloat(restaurant.lat) && 
                    markerLatLng.lng === parseFloat(restaurant.lon)) {
                    foundMarker = layer;
                }
            }
        });
        return foundMarker;
    }

    setupEventListeners() {
        this.createCuisineFilterOptions();

        // Price filter listeners
        const priceCheckboxes = document.querySelectorAll('input[name="price"]');
        priceCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    this.selectedPrices.add(checkbox.value);
                } else {
                    this.selectedPrices.delete(checkbox.value);
                }
                this.updateDisplay();
            });
        });

        // Meal filter listeners
        const mealCheckboxes = document.querySelectorAll('input[name="meal"]');
        mealCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    this.selectedMeals.add(checkbox.value);
                } else {
                    this.selectedMeals.delete(checkbox.value);
                }
                this.updateDisplay();
            });
        });

        // Cuisine filter listeners
        const cuisineCheckboxes = document.querySelectorAll('input[name="cuisine"]');
        cuisineCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    this.selectedCuisines.add(checkbox.value.toLowerCase());
                } else {
                    this.selectedCuisines.delete(checkbox.value.toLowerCase());
                }
                this.updateDisplay();
            });
        });

        // Filter button listeners
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const filterGroup = button.closest('.filter-group');
                const options = filterGroup.querySelector('.filter-options');
                const wasActive = button.classList.contains('active');

                // Close all other filter options
                document.querySelectorAll('.filter-options').forEach(opt => {
                    opt.classList.remove('show');
                });
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Toggle current filter
                if (!wasActive) {
                    options.classList.add('show');
                    button.classList.add('active');
                }
            });
        });

        // Close filters when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-group')) {
                document.querySelectorAll('.filter-options').forEach(opt => {
                    opt.classList.remove('show');
                });
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            if (this.map) {
                this.map.invalidateSize();
            }
        });
    }

    updateMap(filteredRestaurants) {
        // Clear existing markers
        this.map.eachLayer((layer) => {
            if (layer instanceof L.Marker) {
                this.map.removeLayer(layer);
            }
        });

        // Add markers for filtered restaurants
        filteredRestaurants.forEach(restaurant => {
            if (!isNaN(parseFloat(restaurant.lat)) && !isNaN(parseFloat(restaurant.lon))) {
                const marker = L.marker([parseFloat(restaurant.lat), parseFloat(restaurant.lon)])
                    .addTo(this.map)
                    .bindPopup(() => {
                        const popupContent = document.createElement('div');
                        popupContent.innerHTML = `
                            <strong>${restaurant.place_name}</strong><br>
                            <i>${restaurant.cuisine}, ${restaurant.budget}</i>
                        `;
                        return popupContent;
                    }, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
            }
        });

        // Adjust map bounds to show all markers
        if (filteredRestaurants.length > 0) {
            const bounds = L.latLngBounds(filteredRestaurants
                .filter(r => !isNaN(parseFloat(r.lat)) && !isNaN(parseFloat(r.lon)))
                .map(r => [parseFloat(r.lat), parseFloat(r.lon)]));
            this.map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    createCuisineFilterOptions() {
        const cuisineContainer = document.querySelector('.filter-group[data-filter="cuisine"] .filter-options');
        if (!cuisineContainer) {
            console.error('Cuisine filter container not found');
            return;
        }
        cuisineContainer.innerHTML = '';

        const selectedNeighborhoods = this.getSelectedNeighborhoods();
        const filteredRestaurants = this.restaurants.filter(restaurant => 
            selectedNeighborhoods.includes(restaurant.neighborhood_clean));

        const cuisineSet = new Set(
            filteredRestaurants
                .map(restaurant => restaurant.cuisine)
                .filter(cuisine => cuisine !== undefined)
        );

        const sortedCuisines = Array.from(cuisineSet).sort();

        sortedCuisines.forEach(cuisine => {
            const label = document.createElement('label');
            label.className = 'filter-option';
            label.innerHTML = `<input type="checkbox" name="cuisine" value="${cuisine.toLowerCase()}"> ${cuisine}`;
            cuisineContainer.appendChild(label);
        });
    }
}

// Initialize display and add event listeners
document.addEventListener('DOMContentLoaded', async function() {
    const display = new RestaurantDisplay();
    await display.fetchRestaurants();
    display.setupEventListeners();
    display.updateDisplay();
});
</script>
</body>
</html>

